- name: Add Replication Subnet
  ansible.windows.win_powershell:
    script: |
      [CmdletBinding()]
      param (
          [String]
          $SubnetName,
          [String]
          $SiteName
      )
      Import-Module ActiveDirectory
      try {
        $Subnet = Get-ADReplicationSubnet -Identity $SubnetName
      }
      catch {
        $Subnet = $null
      }
      if ($null -ne $Subnet) {
        $Ansible.Changed = $false
      }
      else {
        $Ansible.Changed = $true
        New-ADReplicationSubnet -Name $SubnetName -Site $SiteName
      }
    parameters:
      SubnetName: "{{ item }}"
      SiteName: "{{ wdrs_site_name }}"
  with_items: "{{ wdrs_subnets }}"
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: "{{ domain_name }}\\Administrator"
    ansible_become_password: "{{ domain_password }}"
    ansible_become_flags: logon_flags=