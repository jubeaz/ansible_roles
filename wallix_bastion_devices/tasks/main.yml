#---
#- name: "Creating devices"
#  ansible.builtin.uri:
#    url: "{{ wallix_bastion_device_url }}/devices"
#    method: POST
#    body_format: json
#    validate_certs: false
#    status_code:
#      - 204
#    headers:
#      Cookie: "wab_session_id={{ wallix_bastion_device_cookie.cookies['wab_session_id'] }}"
#    body: |
#      {
#        "device_name": "{{ item.key }}",
#        "host": "{{ item.value.ip }}",
#        "local_domains": [
#            {
#                "domain_name": "local",
#                "description": "the first local domain",
#                "enable_password_change": true,
#                "password_change_policy": "default",
#                "password_change_plugin": "Windows"
#            }
#        ],
#        "services": [
#            {
#                "service_name": "rdp_local_account",
#                "protocol": "RDP",
#                "port": 3389,
#                "connection_policy": "RDP",
#                "global_domains": [],
#                "subprotocols": ["RDP_CLIPBOARD_UP", "RDP_CLIPBOARD_DOWN", "RDP_CLIPBOARD_FILE", "RDP_DRIVE" ]
#            },
#            {
#                "service_name": "ssh_local_account",
#                "protocol": "SSH",
#                "port": 22,
#                "connection_policy": "SSH",
#                "global_domains": [],
#                "subprotocols": ["SSH_SHELL_SESSION", "SSH_REMOTE_COMMAND", "SSH_SCP_UP", "SSH_SCP_DOWN", "SSH_X11", "SFTP_SESSION"]
#            }
#        ],
#      }
#  with_dict: "{{ wallix_bastion_device_devices }}"
#  when: wallix_bastion_device_action == 'create'

- name: Create devices
  include_tasks: create_device.yml
  with_dict: "{{ wallix_bastion_device_devices }}"
  loop_control:
    loop_var: device
  when: wallix_bastion_device_action == 'create'

- name: Get devices ids
  include_tasks: get_device_id.yml
  with_dict: "{{ wallix_bastion_device_devices }}"
  loop_control:
    loop_var: device
  when: wallix_bastion_device_action in ['create', 'get']
